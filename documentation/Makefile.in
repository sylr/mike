# Mike's documentation Makefile
# author: Sylvain Rabot <sylvain@abstraction.fr>
# date: 19/07/2010
# copyright: All rights reserved

#          __  _________ ______
#         /  |/  /  _/ //_/ __/
#        / /|_/ // // ,< / _/  
#       /_/  /_/___/_/|_/___/  
#

# -- default target ------------------------------------------------------------

all::

# -- variables -----------------------------------------------------------------

ECHO                = @ECHO@
ASCIIDOC            = @ASCIIDOC@
ASCIIDOC_EXTRA      = -a data-uri -a icons -a toc -a iconsdir=/usr/share/asciidoc/icons --unsafe
DOCBOOK2ODF         = @DOCBOOK2ODF@
DOCBOOK2ODF_EXTRA   = --force --quiet
DOCBOOK2PDF         = @DOCBOOK2PDF@
DOCBOOK2PDF_EXTRA   =
A2X                 = @A2X@
A2X_EXTRA           =
XMLTO               = @XMLTO@
XMLTO_EXTRA         =
INSTALL             = @INSTALL@
DOC_TXT             = $(wildcard *.txt)
DOC_HTML            = $(patsubst %.txt, %.html, $(DOC_TXT))
DOC_XML             = $(patsubst %.txt, %.xml,  $(DOC_TXT))
DOC_ODT             = $(patsubst %.txt, %.odt,  $(DOC_TXT))
DOC_PDF             = $(patsubst %.txt, %.pdf,  $(DOC_TXT))
DOC_MAN1            = $(patsubst %.txt, %.1,    $(DOC_TXT))

prefix              = @prefix@
htmldir             ?= $(prefix)/share/doc/mike
pdfdir              ?= $(prefix)/share/doc/mike
mandir              ?= $(prefix)/share/man
man1dir             =  $(mandir)/man1

# -- targets -------------------------------------------------------------------

all:: html man

html: $(DOC_HTML)

xml: $(DOC_XML)

man: $(DOC_XML) $(DOC_MAN1)

odt: $(DOC_XML) $(DOC_ODT)

pdf: $(DOC_XML) $(DOC_PDF)

# -- files ---------------------------------------------------------------------

%.html : %.txt
	@$(ECHO) '    ' ASCIIDOC HTML $@; $(ASCIIDOC) $(ASCIIDOC_EXTRA) -b xhtml11 -o $@ $<

%.xml : %.txt
	@$(ECHO) '    ' ASCIIDOC DOCBOOK $@; $(ASCIIDOC) $(ASCIIDOC_EXTRA) -b docbook -d manpage -o $@ $<

%.1 : %.xml
	@$(ECHO) '    ' XMLTO MAN  $@; $(XMLTO) -o ./ man $< 2> /dev/null

%.pdf : %.xml
	@$(ECHO) '    ' DOCBOOK2PDF $@; $(DOCBOOK2PDF) $(DOCBOOK2PDF_EXTRA) -o ./ $<

%.odt : %.xml
	@$(ECHO) '    ' DOCBOOK2ODF $@; $(DOCBOOK2ODF) $(DOCBOOK2ODF_EXTRA) --output-file $@ $<

# -- install -------------------------------------------------------------------

install: install-html install-man

install-html: html
	$(INSTALL) -d -m 755 $(htmldir)
	$(INSTALL) -m 644 $(DOC_HTML) $(htmldir)

install-man: man
	$(INSTALL) -d -m 755 $(man1dir)
	$(INSTALL) -m 644 $(DOC_MAN1) $(man1dir)

# -- clean ---------------------------------------------------------------------

clean:
	@$(RM) $(DOC_HTML)
	@$(RM) $(DOC_XML)
	@$(RM) $(DOC_ODT)
	@$(RM) $(DOC_PDF)
	@$(RM) $(DOC_MAN1)
	@$(RM) *~

